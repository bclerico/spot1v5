<?phpinclude("uFunctions_1.php");include("uFunctions_2.php");session_start();// if not coming from another screen then abortif (!isset($_SESSION['from'])) {	header("Location: abort.html" );	exit();}// if  coming from somewhere other than this screen, initialize  as FIRST TIME hereif ($_SESSION['from'] != "cons_01.php") {	$_SESSION['status'] = 0;	$_SESSION['from'] = "cons_01.php";}// if FIRST TIME here, insert the screen defaults into the SESSION variablesif ($_SESSION['status'] == 0) {	$_SESSION['subject_filter'] = "1";	$_SESSION['query'] = "1"; 	$_SESSION['msg'] = "Welcome!";		$_SESSION['status'] = 1;	if( isset($_SESSION['spot_device_name'])) {		$_SESSION['device_filter'] = $_SESSION['spot_device_name'];	}	else {		$_SESSION['device_filter'] = "*";	}}// use the SESSION variables for the query variables$device_filter = $_SESSION['device_filter'];  // this is the "who"$subject_filter = $_SESSION['subject_filter'];  // this is the "which"$query = $_SESSION['query'];// no one is signed  in so set the default base camp to the middle of the USA$centerLat = 40.655;$centerLng = -97.293;$mapscale = 4;// if someone is logged in then their basecamp Lat and Long is in the SESSIONif (isset($_SESSION['bc_long'])) {	$centerLat = $_SESSION['bc_lat'];	$centerLng = $_SESSION['bc_long'];	$mapscale = 4;}$q_string = "";if ($query == "1") {  // All Points	$q_string = "select oid, device, latitude, longitude, location_dto, subject, msg from spot_msg ";	if ($device_filter != "*") {  // specific device requested		$q_string = $q_string . "where device='" . $device_filter . "' ";				// narrow down by "which" Subject FIlter if "All Subjects" not selected		if ($subject_filter == "2") {			$q_string = $q_string . "AND subject like 'Check-in/OK%' ";		}		elseif ($subject_filter == "3") {			$q_string = $q_string . "AND subject like 'Custom%' ";		}		elseif ($subject_filter == "4") {			$q_string = $q_string . "AND subject like 'Help%' ";		}	}	else {  // get all devices		// narrow down by "which" Subject FIlter if "All Subjects" not selected		if ($subject_filter == "2") {			$q_string = $q_string . "where subject like 'Check-in/OK%' ";		}		elseif ($subject_filter == "3") {			$q_string = $q_string . "where subject like 'Custom%' ";		}		elseif ($subject_filter == "4") {			$q_string = $q_string . "where subject like 'Help%' ";		}		$q_string = $q_string . " ";	}	$q_string = $q_string . "order by 2, 5 desc;";	}elseif ($query == "2") {  //  Last Point	$q_string = "select t2.oid, t2.device, t2.latitude, t2.longitude, t2.point_date_time, t2.location_dto, t2.subject, t2.msg from ";	$q_string = $q_string . "(select device, max(point_date_time) as newest_date_time from spot_msg group by device) as t1 ";	$q_string = $q_string . "inner join spot_msg as t2 on t2.device = t1.device and t2.point_date_time = t1.newest_date_time ";	if ($device_filter != "*") {		$q_string = $q_string . "AND t2.device='" . $device_filter . "' ";				if ($subject_filter == "2") {			$q_string = $q_string . "AND t2.subject like 'Check-in/OK%' ";		}		elseif ($subject_filter == "3") {			$q_string = $q_string . "AND t2.subject like 'Custom%' ";		}		elseif ($subject_filter == "4") {			$q_string = $q_string . "AND t2.subject like 'Help%' ";		}		else {			$q_string = $q_string . ";";		}	}	else {		if ($subject_filter == "2") {			$q_string = $q_string . "AND t2.subject like 'Check-in/OK%' ";		}		elseif ($subject_filter == "3") {			$q_string = $q_string . "AND t2.subject like 'Custom%' ";		}		elseif ($subject_filter == "4") {			$q_string = $q_string . "AND t2.subject like 'Help%' ";		}		else {			$q_string = $q_string . ";";		}	}}elseif ($query == "3") {  // All  Points in the last 24 hours	$yesterday = date("Y-m-d G:i:s",strtotime("-24 hours"));		$q_string = "select oid, device, latitude, longitude, location_dto, subject, msg from spot_msg WHERE point_date_time > '" . $yesterday . "' ";	if ($device_filter != "*") {		$q_string = $q_string . "AND device='" . $device_filter . "' ";				if ($subject_filter == "2") {			$q_string = $q_string . "AND subject like 'Check-in/OK%' ";		}		elseif ($subject_filter == "3") {			$q_string = $q_string . "AND subject like 'Custom%' ";		}		elseif ($subject_filter == "4") {			$q_string = $q_string . "AND subject like 'Help%' ";		}	}	else {		if ($subject_filter == "2") {			$q_string = $q_string . "AND subject like 'Check-in/OK%' ";		}		elseif ($subject_filter == "3") {			$q_string = $q_string . "AND subject like 'Custom%' ";		}		elseif ($subject_filter == "4") {			$q_string = $q_string . "AND subject like 'Help%' ";		}		$q_string = $q_string . " ";	}	$q_string = $q_string . "order by 2, 5 desc;";}$rs = db_query($q_string, $_SESSION["db_host_name"], $_SESSION["db_user_id"], $_SESSION["db_password"], $_SESSION["db_name"], $_SESSION["db_port"]);// echo "rows returned:" . $rs->num_rows . "<br/>";$x = 0;$latPoints = array();$lngPoints = array();$devices = array();$subjects = array();$location_dtos = array();$msgs = array();while ($row = mysqli_fetch_array($rs)) {	$devices[$x] = $row['device'];	$latPoints[$x] = $row['latitude'];	$lngPoints[$x] = $row['longitude'];	$subjects[$x] = $row['subject'];	$location_dtos[$x] = $row['location_dto'];	$msgs[$x] = $row['msg'];	$x++;}// echo "rows processed:" . $x . "<br/>";?><!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>Watch My Spot - Global Expedition Observation Portal: Console</title><meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" /><?php $dijit_style = "claro"?><?php echo insert_css($dijit_style); ?><?php echo insert_dojo(); ?><script language="JavaScript" type="text/javascript">	dojo.require("dojo.parser");	dojo.require("dijit.form.TextBox");	dojo.require("dijit.form.DateTextBox");	dojo.require("dijit.form.Textarea");	dojo.require("dijit.form.Button");	dojo.require("dijit.form.Select");	</script><link href="https://code.google.com/apis/maps/documentation/javascript/examples/default.css" rel="stylesheet" type="text/css" /><script language="JavaScript" type="text/javascript" src="https://maps.google.com/maps/api/js?key=<?php echo $_SESSION['google_maps_api_key'];?>"></script><script language="JavaScript" type="text/javascript">var mapPoints = [];function initialize() {    var myLatLng = new google.maps.LatLng(<?php echo $centerLat . ", " . $centerLng ?>);	    var myOptions = {      zoom: <?php echo $mapscale ?>,      center: myLatLng,      mapTypeId: google.maps.MapTypeId.TERRAIN    };		var map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);	var myPlace = new google.maps.Marker({position: myLatLng, map: map, title: "My Basecamp"});	var infoWindow = new google.maps.InfoWindow({content: "Place Holder for Content"});	var theLatLng = [];	var latPoints = [];	var lngPoints = [];	var devices = [];	var subjects = [];	var msgs = [];	var location_dtos = [];	var contentStrings = []; var image; var image_car = "./images/car.png";  var image_ok = "./images/hiking-ok.png"; 	var image_custom = "./images/hiking-custom.png";	var image_help = "./images/hiking-help.png";		<?php	for ($x = 0; $x < sizeof($latPoints); $x++) {		echo "latPoints[" . $x . "] = " . $latPoints[$x] . ";";		echo "lngPoints[" . $x . "] = " . $lngPoints[$x] . ";";		echo "devices[" . $x . "] = \"" . $devices[$x] . "\";";		echo "subjects[" . $x . "] = \"" . $subjects[$x] . "\";";		echo "location_dtos[" . $x . "] = \"" . $location_dtos[$x] . "\";";		echo "msgs[" . $x . "] = \"" . $msgs[$x] . "\";";				$contentString = "<div id='titleContent'>" . $subjects[$x];		$contentString = $contentString . "<br />".$location_dtos[$x]."</div><br />";		$contentString = $contentString . "<div id='bodyContent'>".$lngPoints[$x]." ".$latPoints[$x]."<br />".$msgs[$x]."</div>";				echo "contentStrings[".$x."] = \"" . $contentString . "\";";	}	?>			for (var i = 0; i < latPoints.length; i++) {		if (subjects[i].substring(0, 4) == "Help") {			image = image_help;		}		else		if (subjects[i].substring(0, 6) == "Custom") {			image = image_custom;		}		else {			image = image_ok;		}		theLatLng[i] = new google.maps.LatLng(latPoints[i], + lngPoints[i]);				mapPoints[i] = new google.maps.Marker({			position: theLatLng[i],			map: map,			icon: image,			animation: google.maps.Animation.DROP,			title: devices[i] + ":" + location_dtos[i],			html: contentStrings[i],			idx: i		});				google.maps.event.addListener(mapPoints[i], 'click', function() {infoWindow.setContent(this.html);infoWindow.open(map,this)});		google.maps.event.addListener(mapPoints[i], 'mouseover', function() {document.getElementById(this.idx).style.backgroundColor = 'gray';});		google.maps.event.addListener(mapPoints[i], 'mouseout', function() {document.getElementById(this.idx).style.backgroundColor = 'white';});		google.maps.event.addDomListener(window, 'resize', resize_map_layout);			}		resize_map_layout();}function resize_map_layout() {	var m = document.getElementById('map');	var m_width = m.offsetWidth;		var ml = document.getElementById('map_layout');	var ml_width = m_width - 300;	ml.style.width=ml_width+'px';}function clicked_a_row(x,mp) {	google.maps.event.trigger(mp, "click");}function moused_in_a_row(mp) {	mp.setAnimation(google.maps.Animation.BOUNCE);}function moused_out_a_row(mp) {	mp.setAnimation(null);}</script></head><body class="<?php echo $dijit_style;?>" onload="initialize();"><div id='header'>	<?php 		include("header.php");		echo insert_nav("console");	?>	</div><div id='content'>	<div id='map'>		<div id='map_form'>			<p>			<?php include("cons_01_form.php"); ?>			</p>			<?php			$str = "<table border=1>";			for ($x = 0; $x < sizeof($latPoints); $x++) {				$str = $str . "<tr id ='".$x."' onclick='clicked_a_row(".$x.", mapPoints[".$x."]);' onmouseover='moused_in_a_row(mapPoints[".$x;				$str = $str . "]);' onmouseout='moused_out_a_row(mapPoints[".$x."]);'><td>" . $devices[$x] . "</td><td>";				$str = $str . $location_dtos[$x] . "</td></tr>";			}			$str = $str . "</table>";			echo $str;			?>		</div>			<div id='map_layout'>			<div id='map_canvas' style="width:100%; height:100%">JavaScript must be enabled to use this application</div>		</div>	</div>		<div id='right_col'>		<?php include("right_col.php"); ?>	</div></div><div id='footer'><?php include("footer.php"); ?></div></body></html>